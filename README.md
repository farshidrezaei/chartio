# Elasquent , Elasticsearch Orm and Query builder for Laravel

Elasquent, an object-relational mapper (ORM) that makes it enjoyable to interact with your elasticsearch. When using Elasquent, each index  has a corresponding "Model" that is used to interact with that index. In addition to retrieving documents from the elasticsearch index, Elasquent models allow you to select from the index as well.

## Elasticsearch Connection
Set bellow config to `.env` file
```dotenv
ELASTIC_HOST=
ELASTIC_PORT=
ELASTIC_USERNAME=
ELASTIC_PASSWORD=
```

## Generating Model Classes

To get started, let's create an Elasquent model. Models typically live in the  `app\Models\Elasquent`  directory and extend the  `LifeWeb\Elasquent\Services\Model\Model`  class.
Models Fields typically live in the  `app\Models\Elasquent\Fields`  directory and extend the  `LifeWeb\Elasquent\Services\Model\Fields\AbstractFields`  class.

You may use the  `elasquent:make-model`  [Artisan command](https://laravel.com/docs/8.x/artisan)  to generate a new model:

```bash
php artisan elasquent:make-model ElasticNewsPost
```
then you have a `ElasticNews.php` in `app\Models\Elasquent` directory and `ElasticNewsFields.php` in `app\Models\Elasquent\Fields` .

## Elasquent Model Conventions

Models generated by the  `elasquent:make-model`  command will be placed in the  `app/Models/Elasquent`  directory. Let's examine a basic model class and discuss some of Elasquent's key conventions:

```php
<?php  
  
namespace App\Models\Elasquent;  
  
use App\Models\Elasquent\Fields\ElasticNewsFields;  
use LifeWeb\Elasquent\Services\Model\Fields\DefineFieldInterface;  
use LifeWeb\Elasquent\Services\Model\Fields\FieldsInterface;  
use LifeWeb\Elasquent\Services\Model\Model;  
  
class ElasticNews extends Model implements DefineFieldInterface  
{  
	  protected $guarded = [];  
	  
	  public function indexes(): array  
	  {  
		  return [  
			  'fa' => 'my_index',  
		  ];  
	  }  

	  public function fields(): FieldsInterface  
	  {  
		  return app(ElasticNewsFields::class);  
	  }  
  
}
```

Model fields generated by the  `elasquent:make-model`  command will be placed in the  `app/Models/Elasquent/Fields`  directory. Let's examine a basic model class and discuss some of Elasquent's key conventions:


```php
<?php  
  
namespace App\Models\Elasquent\Fields;  
  
  
use LifeWeb\Elasquent\Services\Model\Fields\AbstractFields;  
use LifeWeb\Elasquent\Services\Model\Fields\FieldsInterface;  
  
class ElasticNewsFields extends AbstractFields implements FieldsInterface  
{  
	 
	 /**  
	 * @return string  
	 */  
	 public function createdAt(): string  
	 {  
		  return 'created_at_field';  
	 }  
	  
	  
	 /**  
	 * Indicates title field in elasticsearch. 
	 * @return string  
	 */  
	 public function title(): string  
	 {  
		  // TODO: Implement title() method.  
	 }  
	  
	 /**  
	 * Indicates content field in elasticsearch.
	 * @return string  
	 */  
	 public function content(): string  
	 {  
		  // TODO: Implement content() method.  
	 }  
	  
	 /**  
	 * Indicates resources field in elasticsearch.
	 * @return string  
	 */  
	 public function resource(): string  
	 {  
		  // TODO: Implement resource() method.  
	 }  
	  
	 /**  
	 * Determines sortable fields.
	 * @return array  
	 */  
	 public function sortables(): array  
	 {  
		  // TODO: Implement sortables() method.  
	 }  
	  
	 /**  
	 * Determines subject field.
	 * @return string  
	 */  
	 public function subject(): string  
	 {  
		  // TODO: Implement subject() method.  
	 }  
	  
	 /**  
	 * Determines ngram field.
	 * @return mixed  
	 */  
	 public function ngram(): string  
	 {  
		  // TODO: Implement ngram() method.  
	 }  
	  
	 /**  
	 * Specifies searchable fields.
	 * @return array  
	 */  
	 public function searchableFields(): array  
	 {  
		  // TODO: Implement searchableFields() method.  
	 }  
	  
}
```

### index Names

After glancing at the example above, you may have noticed that we did not tell Elasquent which elasticsearch index corresponds to our  `ElasticNews`  model. you must manually specify the model's index name by defining  `indexes`  function on the model:

```php
<?php

namespace App\Models\Elasquent;

use LifeWeb\Elasquent\Services\Model\Model;

class ElasticNews extends Model
{
		public function indexes(): array  
		{  
		  return [  
		  'fa' => 'news_index',  
		  ];  
		}
}
```

## Retrieving Models

Once you have created a model and its associated elasticsearch index , you are ready to start retrieving data from your elasticsearch. You can think of each Elasquent model as a powerful  Query builder  allowing you to fluently query the elasticsearch indexes associated with the model. The model's  `collect`  method will retrieve limited of the documents from the model's associated elasticsearch index:

```php
use Modules\Platform\Services\Elasticsearch\Elasticsearch;  
use Modules\Platform\Models\ElasticNewsPost;

$newsQuery = new Elasticsearch(new ElasticNewsPost());

foreach ($newsQuery->collect() as $news) {
    echo $news->title;
}
```

#### Building Queries

The Elasquent  `collect`  method will return limited number of the results in the model's index. However, since each Elasquent model serves as a query builder by using Elasticsearch Class, you may add additional constraints to queries and then invoke the  `collect`  method to retrieve the results:

```php
$newsQuery = new Elasticsearch(new ElasticNews());
$newsQuery->term('active', 1)
               ->sortDesc('title')
               ->size(100)
               ->collect();
```

### Collections

As we have seen, Elasquent methods like  `collect`   retrieve multiple documents from the elasticsearch index. However, these methods don't return a plain PHP array. Instead, an instance of  `LifeWeb\Elasquent\Services\Collection`  is returned.

The Elasquent  `Collection`  class extends Laravel's base  `Illuminate\Support\Collection`  class, which provides a  [variety of helpful methods](https://laravel.com/docs/8.x/collections#available-methods)  for interacting with data collections. For example, the  `reject`  method may be used to remove models from a collection based on the results of an invoked closure:

```php
$newsQuery = new Elasticsearch( new ElasticNews() );
$news=$newsQuery->term( 'active', 1 )
               ->sortDesc( 'title' )
               ->size( 100 )
               ->collect();

$news = $news->reject( function ( $newsItem ) {
    return $newsItem->lf_influence <= 0.5;
});
```

In addition to the methods provided by Laravel's base collection class, the Elasquent collection class provides a few extra methods that are specifically intended for interacting with collections of Elasquent models.

Since all of Laravel's collections implement PHP's iterable interfaces, you may loop over collections as if they were an array:

```php
foreach ($news as $newsItem) {
    echo $newsItem->title;
}
```
### Advanced queries

#### bools queries

Elasquent also offers advanced bool subquery support, which allows you to pull information from related index in a single query. the bool queries contains bellow functions:

- filter
- must
- mustNot
- should

>  for more information read elasticsearch doc.

```php
$newsQuery = new Elasticsearch( new ElasticNews() );
$news = $newsQuery->term('active', 1)
				->must( function( Elasticsearch $must ){
					return $must->matchPhrase( 'lead', 'Farshid' );
				} )
               ->sortDesc( 'title' )
               ->size( 100 )
               ->collect();
```

## Retrieving Single Models / Aggregates

In addition to retrieving all of the records matching a given query, you may also retrieve single records using the  `find`,  `first`, or  `firstWhere`  methods. Instead of returning a collection of models, these methods return a single model instance:

```php
$newsQuery = new Elasticsearch( new ElasticNews() );

// Retrieve a model by its primary key...
$newsItem = $newsQuery->find( 1 );

// Retrieve the first model matching the query constraints...
$newsItem = $newsQuery->term( 'active', 1 )->first();
```

### Not Found Exceptions

Sometimes you may wish to throw an exception if a model is not found. This is particularly useful in routes or controllers. The  `findOrFail`  and  `firstOrFail`  methods will retrieve the first result of the query; however, if no result is found, an  `LifeWeb\Elasquent\Exceptions\ModelNotFoundException`  will be thrown:

```php
$newsQuery = new Elasticsearch( new ElasticNews() );

$newsItem = $newsQuery->findOrFail(1);

$flight = $newsQuery->term('active', 3)->firstOrFail();
```

If the  `ModelNotFoundException`  is not caught, a 404 HTTP response is automatically sent back to the client:

```php
$newsQuery = new Elasticsearch( new ElasticNews() );
Route::get('/api/flights/{id}', function ($id) {
    return $newsQuery->findOrFail($id);
});
```

### Retrieving Aggregates

When interacting with Elasquent models, you may also use the `count`,  `termsAggregation`,  `dateHistogram`,  and other aggregate methods provided by the ELasticsearch . As you might expect, these methods return a scalar value instead of an Elasquent model instance:

```php
$newsQuery = new Elasticsearch( new ElasticNews() );

//for counting items in specified field like wordCLoud
$count = $newsQuery->term('active', 1)->count(); // 515145


//for counting terms in specified field like wordCLoud
$wordCloud =  $newsQuery->sizeLess()
              ->terms('active', 1)
              ->termsAggregation('hashtagCloud','lf_hashtags',['size'=>20])
              ->collect()
              ->getAggregations()
              ->bucket('hashtagCloud')
              ->cloud('key', 'count');
              /**
               [
                     [key=>farshid, count=>30],
                     [key=>payam,   count=>60],
               ]
              */


//for counting items in specified range date field
$dateHistogram =  $newsQuery->sizeLess()
		  ->terms('active', 1)
		  ->dateHistogram('histogram','created_at','day','yyyy/MM/dd H:m:s')
		  ->collect()
		  ->getAggregations()
		  ->bucket('histogram')
		  ->toHistogram('2020/10/22','2021/01/15','day','jalali');
		  
```

